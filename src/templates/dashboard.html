{% extends "base.html" %}

{% block content %}
<!-- Service Status -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Service Status</h5>
            </div>
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <p class="mb-2">
                            <span class="status-indicator {% if service_status.is_running %}status-running{% else %}status-stopped{% endif %}"></span>
                            <strong>Status:</strong>
                            {% if service_status.is_running %}
                                <span class="text-success">L√§uft</span>
                            {% else %}
                                <span class="text-danger">Gestoppt</span>
                            {% endif %}
                        </p>
                        <p class="mb-2">
                            <strong>Session ID:</strong>
                            <code>{{ service_status.session_id[:8] if service_status.session_id else 'N/A' }}...</code>
                        </p>
                        <p class="mb-0">
                            <strong>Fehler:</strong>
                            <span class="{% if service_status.error_count > 0 %}text-warning{% else %}text-success{% endif %}">
                                {{ service_status.error_count }} Fehler
                            </span>
                        </p>
                    </div>
                    <div class="col-md-6 text-end">
                        {% if service_status.is_running %}
                            <button class="btn btn-danger" onclick="controlService('stop')">
                                Service Stoppen
                            </button>
                        {% else %}
                            <button class="btn btn-spotify" onclick="controlService('start')">
                                Service Starten
                            </button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Current Track -->
{% if service_status.has_active_session and service_status.current_track %}
<div class="row">
    <div class="col-12">
        <div class="current-track">
            <h6 class="mb-3">üéµ Aktuell l√§uft:</h6>
            <h4 class="mb-2">{{ service_status.current_track.name | e }}</h4>
            <p class="mb-2">von <strong>{{ service_status.current_track.artist | e }}</strong></p>
            <div class="row">
                <div class="col-md-6">
                    <small>
                        ‚è±Ô∏è H√∂rdauer: <strong id="listening-duration">{{ service_status.current_track.listening_duration }}</strong> Sekunden
                    </small>
                </div>
                <div class="col-md-6 text-md-end">
                    <small>
                        {% if service_status.current_track.added_to_playlist %}
                            ‚úÖ <span class="text-success">Zur Playlist hinzugef√ºgt</span>
                        {% else %}
                            ‚è≥ Noch nicht hinzugef√ºgt
                        {% endif %}
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Statistics Overview -->
<div class="row mt-4">
    <div class="col-md-3">
        <div class="card metric-card">
            <div class="metric-value" id="total-tracks">{{ stats.total_tracks_played or 0 }}</div>
            <div class="metric-label">Songs geh√∂rt (7 Tage)</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card metric-card">
            <div class="metric-value" id="added-tracks">{{ stats.tracks_added_to_playlist or 0 }}</div>
            <div class="metric-label">Songs hinzugef√ºgt</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card metric-card">
            <div class="metric-value" id="discovery-rate">{{ "%.1f"|format(stats.discovery_rate or 0) }}%</div>
            <div class="metric-label">Discovery Rate</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card metric-card">
            <div class="metric-value" id="avg-duration">{{ "%.0f"|format(stats.average_listening_duration_seconds or 0) }}s</div>
            <div class="metric-label">√ò H√∂rdauer</div>
        </div>
    </div>
</div>

<!-- Charts -->
<div class="row mt-4">
    <!-- Daily Activity Chart -->
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">üìä T√§gliche Aktivit√§t (30 Tage)</h5>
            </div>
            <div class="card-body" style="height: 400px;">
                <canvas id="activityChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Top Artists -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">üé§ Top Artists</h5>
            </div>
            <div class="card-body">
                <div id="top-artists-list">
                    {% for artist in stats.top_artists[:5] %}
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="text-truncate">{{ artist.artist_name | e }}</span>
                        <span class="badge bg-spotify rounded-pill">{{ artist.play_count }}</span>
                    </div>
                    {% else %}
                    <p class="text-muted text-center">Noch keine Daten verf√ºgbar</p>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Auto-refresh indicator -->
<div class="row mt-3">
    <div class="col-12">
        <div class="text-center">
            <small class="text-muted">
                <span id="refresh-indicator">üîÑ</span>
                Dashboard wird automatisch aktualisiert - Letzte Aktualisierung: <span id="last-update">{{ current_time.strftime('%H:%M:%S') if current_time else '' }}</span>
            </small>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Global variables
    window.activityChart = null;
    window.chartLoading = false;
    let refreshInterval = null;

    // Service Control
    function controlService(action) {
        const button = event.target;
        button.disabled = true;
        button.innerHTML = action === 'start' ? 'Startet...' : 'Stoppt...';

        fetch(`/service/${action}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload(); // Reload page to show new status
            } else if (data.needs_auth && data.auth_url) {
                // Spotify-Authentifizierung erforderlich
                if (confirm('Spotify-Authentifizierung erforderlich. M√∂chten Sie sich jetzt anmelden?')) {
                    window.open(data.auth_url, '_blank', 'width=600,height=700');
                    // Nach der Auth-Best√§tigung die Seite neu laden
                    setTimeout(() => {
                        location.reload();
                    }, 3000);
                }
                button.disabled = false;
                button.innerHTML = action === 'start' ? 'Service Starten' : 'Service Stoppen';
            } else {
                alert('Fehler: ' + data.message);
                button.disabled = false;
                button.innerHTML = action === 'start' ? 'Service Starten' : 'Service Stoppen';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Fehler beim ' + (action === 'start' ? 'Starten' : 'Stoppen') + ' des Services');
            button.disabled = false;
            button.innerHTML = action === 'start' ? 'Service Starten' : 'Service Stoppen';
        });
    }

    // Load Activity Chart
    function loadActivityChart() {
        // Verhindere mehrfache gleichzeitige Aufrufe
        if (window.chartLoading) {
            console.log('Chart loading already in progress, skipping...');
            return;
        }

        window.chartLoading = true;
        console.log('Loading activity chart...');

        // Pr√ºfe ob Chart.js verf√ºgbar ist
        if (typeof Chart === 'undefined') {
            console.error('Chart.js is not loaded');
            // Zeige Fehlermeldung direkt im Container
            const errorContainer = document.querySelector('.card-body');
            if (errorContainer) {
                errorContainer.innerHTML = `
                    <div class="text-center text-danger py-5">
                        <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                        <h6>Chart.js konnte nicht geladen werden</h6>
                        <p class="small">Bitte laden Sie die Seite neu.</p>
                        <button class="btn btn-outline-primary btn-sm" onclick="location.reload()">
                            Seite neu laden
                        </button>
                    </div>
                `;
            }
            window.chartLoading = false;
            return;
        }

        console.log('Chart.js version:', Chart.version);

        fetch('/api/activity?days=30')
            .then(response => {
                console.log('API response status:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Activity data received:', data);

                // Robuste Chart-Container-Suche
                let chartContainer = null;

                // 1. Versuche √ºber existierenden Canvas
                const existingCanvas = document.getElementById('activityChart');
                if (existingCanvas && existingCanvas.parentElement) {
                    chartContainer = existingCanvas.parentElement;
                }

                // 2. Fallback: Suche √ºber Card-Header Text
                if (!chartContainer) {
                    const headers = document.querySelectorAll('.card-header h5');
                    for (let header of headers) {
                        if (header.textContent && header.textContent.includes('T√§gliche Aktivit√§t')) {
                            chartContainer = header.closest('.card').querySelector('.card-body');
                            break;
                        }
                    }
                }

                // 3. Letzter Fallback: Suche √ºber Canvas in Card-Body
                if (!chartContainer) {
                    const canvasInCard = document.querySelector('.card-body canvas');
                    if (canvasInCard) {
                        chartContainer = canvasInCard.parentElement;
                    }
                }

                if (!Array.isArray(data) || data.length === 0) {
                    console.warn('No activity data available');
                    // Zeige Nachricht f√ºr fehlende Daten
                    if (chartContainer) {
                        chartContainer.innerHTML = `
                            <div class="text-center text-muted py-5">
                                <i class="fas fa-chart-line fa-3x mb-3 opacity-50"></i>
                                <h6>Noch keine Aktivit√§tsdaten verf√ºgbar</h6>
                                <p class="small">Daten erscheinen hier, sobald Sie den Service gestartet und Musik geh√∂rt haben.</p>
                            </div>
                        `;
                    }
                    window.chartLoading = false;
                    return;
                }

                if (!chartContainer) {
                    console.error('Chart container not found');
                    window.chartLoading = false;
                    return;
                }

                // Prepare data
                const labels = data.map(day => new Date(day.date).toLocaleDateString('de-DE', {month: 'short', day: 'numeric'})).reverse();
                const tracksPlayed = data.map(day => day.tracks_played || 0).reverse();
                const tracksAdded = data.map(day => day.tracks_added || 0).reverse();

                console.log('Chart data prepared:', { labels, tracksPlayed, tracksAdded });

                // Komplette Canvas-Neuerstellung

                // Zerst√∂re existierenden Chart komplett
                if (window.activityChart && typeof window.activityChart.destroy === 'function') {
                    console.log('Destroying existing chart');
                    window.activityChart.destroy();
                    window.activityChart = null;
                }

                // Entferne alten Canvas komplett
                const oldCanvas = document.getElementById('activityChart');
                if (oldCanvas) {
                    oldCanvas.remove();
                }

                // Erstelle neuen Canvas mit fester ID f√ºr Konsistenz
                const newCanvas = document.createElement('canvas');
                newCanvas.id = 'activityChart';
                // Keine feste H√∂he - wird von CSS des Containers bestimmt
                chartContainer.appendChild(newCanvas);

                console.log('Created new canvas with ID:', newCanvas.id);

                // Erstelle neuen Chart mit neuem Canvas
                window.activityChart = new Chart(newCanvas.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Songs geh√∂rt',
                            data: tracksPlayed,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            fill: true,
                            tension: 0.4
                        }, {
                            label: 'Songs hinzugef√ºgt',
                            data: tracksAdded,
                            borderColor: '#1db954',
                            backgroundColor: 'rgba(29, 185, 84, 0.1)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                                display: true
                            }
                        },
                        scales: {
                            x: {
                                display: true,
                                grid: {
                                    display: true
                                }
                            },
                            y: {
                                beginAtZero: true,
                                display: true,
                                grid: {
                                    display: true
                                },
                                ticks: {
                                    stepSize: 1
                                }
                            }
                        }
                    }
                });

                console.log('Chart created successfully');
                window.chartLoading = false;
            })
            .catch(error => {
                console.error('Error loading activity chart:', error);
                // Zeige Fehlermeldung
                const errorContainer = document.querySelector('.card-body');
                if (errorContainer) {
                    errorContainer.innerHTML = `
                        <div class="text-center text-danger py-5">
                            <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                            <h6>Chart konnte nicht geladen werden</h6>
                            <p class="small">${error.message}</p>
                            <button class="btn btn-outline-primary btn-sm" onclick="loadActivityChart()">
                                Erneut versuchen
                            </button>
                        </div>
                    `;
                }
                window.chartLoading = false;
            });
    }

    // Show message in chart area
    function showChartMessage(message) {
        // Reset loading flag
        window.chartLoading = false;

        // Zerst√∂re Chart falls vorhanden
        if (window.activityChart && typeof window.activityChart.destroy === 'function') {
            window.activityChart.destroy();
            window.activityChart = null;
        }

        // Finde Chart Container
        let chartContainer = document.querySelector('#activityChart')?.parentElement;
        if (!chartContainer) {
            // Falls Canvas durch ID-√Ñnderung nicht gefunden wird, suche nach card-body
            chartContainer = document.querySelector('.card-body');
        }

        if (chartContainer) {
            chartContainer.innerHTML = `
                <div class="text-center text-muted py-5">
                    <i class="fas fa-chart-line fa-3x mb-3"></i>
                    <p>${message}</p>
                    <button class="btn btn-outline-secondary btn-sm" onclick="loadActivityChart()">
                        Erneut versuchen
                    </button>
                </div>
            `;
        }
    }

    // Update Statistics
    function updateStatistics() {
        fetch('/api/statistics?days=7')
            .then(response => response.json())
            .then(data => {
                document.getElementById('total-tracks').textContent = data.total_tracks_played || 0;
                document.getElementById('added-tracks').textContent = data.tracks_added_to_playlist || 0;
                document.getElementById('discovery-rate').textContent = (data.discovery_rate || 0).toFixed(1) + '%';
                document.getElementById('avg-duration').textContent = Math.round(data.average_listening_duration_seconds || 0) + 's';

                // Update top artists
                const topArtistsList = document.getElementById('top-artists-list');
                if (data.top_artists && data.top_artists.length > 0) {
                    topArtistsList.innerHTML = data.top_artists.slice(0, 5).map(artist => `
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-truncate">${escapeHtml(artist.artist_name)}</span>
                            <span class="badge bg-spotify rounded-pill">${artist.play_count}</span>
                        </div>
                    `).join('');
                }
            })
            .catch(error => {
                console.error('Error updating statistics:', error);
            });
    }

    // Update Status and Current Track
    function updateStatus() {
        fetch('/api/status')
            .then(response => response.json())
            .then(data => {
                // Update current track section
                updateCurrentTrackSection(data);

                // Update last update time
                document.getElementById('last-update').textContent = new Date().toLocaleTimeString('de-DE');
            })
            .catch(error => {
                console.error('Error updating status:', error);
            });
    }

    // Update Current Track Section
    function updateCurrentTrackSection(data) {
        const currentTrackSection = document.querySelector('.current-track');
        const hasActiveSession = data.has_active_session;
        const currentTrack = data.current_track;

        // Check if we should show/hide the current track section
        const currentTrackRow = currentTrackSection?.closest('.row');

        if (hasActiveSession && currentTrack) {
            // Show current track section
            if (currentTrackRow) {
                currentTrackRow.style.display = 'block';
            }

            // Update track info if section exists
            if (currentTrackSection) {
                // Update track name
                const trackNameElement = currentTrackSection.querySelector('h4');
                if (trackNameElement) {
                    trackNameElement.textContent = currentTrack.name || 'Unbekannter Titel';
                }

                // Update artist
                const artistElement = currentTrackSection.querySelector('p strong');
                if (artistElement) {
                    artistElement.textContent = currentTrack.artist || 'Unbekannter Artist';
                }

                // Update listening duration
                const durationElement = document.getElementById('listening-duration');
                if (durationElement && currentTrack.listening_duration !== undefined) {
                    durationElement.textContent = currentTrack.listening_duration;
                }

                // Update playlist status
                const playlistStatusContainer = currentTrackSection.querySelector('.col-md-6.text-md-end small');
                if (playlistStatusContainer) {
                    if (currentTrack.added_to_playlist) {
                        playlistStatusContainer.innerHTML = '‚úÖ <span class="text-success">Zur Playlist hinzugef√ºgt</span>';
                    } else {
                        playlistStatusContainer.innerHTML = '‚è≥ Noch nicht hinzugef√ºgt';
                    }
                }
            } else {
                // Create current track section if it doesn't exist
                createCurrentTrackSection(currentTrack);
            }
        } else {
            // Hide current track section if no active session
            if (currentTrackRow) {
                currentTrackRow.style.display = 'none';
            }
        }
    }

    // Create Current Track Section dynamically
    function createCurrentTrackSection(track) {
        const serviceStatusRow = document.querySelector('.row .card .card-header h5').closest('.row');

        const currentTrackHTML = `
            <div class="row">
                <div class="col-12">
                    <div class="current-track">
                        <h6 class="mb-3">üéµ Aktuell l√§uft:</h6>
                        <h4 class="mb-2">${escapeHtml(track.name || 'Unbekannter Titel')}</h4>
                        <p class="mb-2">von <strong>${escapeHtml(track.artist || 'Unbekannter Artist')}</strong></p>
                        <div class="row">
                            <div class="col-md-6">
                                <small>
                                    ‚è±Ô∏è H√∂rdauer: <strong id="listening-duration">${track.listening_duration || 0}</strong> Sekunden
                                </small>
                            </div>
                            <div class="col-md-6 text-md-end">
                                <small>
                                    ${track.added_to_playlist ?
                                        '‚úÖ <span class="text-success">Zur Playlist hinzugef√ºgt</span>' :
                                        '‚è≥ Noch nicht hinzugef√ºgt'
                                    }
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // Insert after service status
        serviceStatusRow.insertAdjacentHTML('afterend', currentTrackHTML);
    }

    // Utility function to escape HTML
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Initialize dashboard
    document.addEventListener('DOMContentLoaded', function() {
        // Load initial data
        loadActivityChart();

        // Set up auto-refresh intervals
        let chartRefreshCounter = 0;
        let statusRefreshCounter = 0;

        // Live updates for current track (every 2 seconds)
        setInterval(() => {
            updateStatus();
        }, 2000);

        // Statistics and chart updates (every 30 seconds)
        refreshInterval = setInterval(() => {
            updateStatistics();

            // Refresh activity chart every 5 minutes (10 * 30s = 5min)
            chartRefreshCounter++;
            if (chartRefreshCounter >= 10) {
                // Nur Chart neu laden wenn er nicht bereits l√§dt
                if (!window.chartLoading) {
                    console.log('Auto-refreshing activity chart...');
                    loadActivityChart();
                }
                chartRefreshCounter = 0;
            }
        }, 30000); // Refresh statistics every 30 seconds

        // Update last update time indicator
        setInterval(() => {
            const lastUpdateElement = document.getElementById('last-update');
            if (lastUpdateElement) {
                lastUpdateElement.textContent = new Date().toLocaleTimeString('de-DE');
            }
        }, 1000);
    });

    // Clean up on page unload
    window.addEventListener('beforeunload', function() {
        if (refreshInterval) {
            clearInterval(refreshInterval);
        }
        if (window.activityChart && typeof window.activityChart.destroy === 'function') {
            window.activityChart.destroy();
            window.activityChart = null;
        }
    });
</script>
{% endblock %}
